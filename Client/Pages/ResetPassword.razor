@page "/reset-password"
@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject NotificationService NotificationService
@using System.Net.Http.Json;
@layout LoginLayout

<PageTitle>Reset Password</PageTitle>
<RadzenText Text="Reset Password" TextStyle="Radzen.Blazor.TextStyle.H5" class="mb-4" TagName="Radzen.Blazor.TagName.H2" />

<RadzenRow>
    <RadzenColumn SizeMD="12">
        <RadzenTemplateForm Data="@model" Submit="@((ResetPasswordModel m) => OnSubmit(m))">
            <RadzenAlert Shade="Shade.Lighter" Variant="Variant.Flat" Size="AlertSize.Small" 
                AlertStyle="AlertStyle.Danger" Visible="@errorVisible">@error</RadzenAlert>

            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-4">
                    Enter your email address and we'll send you a link to reset your password.
                </RadzenText>

                <RadzenFormField Text="Email" Variant="Variant.Flat">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="@model.Email" 
                                       style="display: block; width: 100%" 
                                       Name="Email" 
                                       Placeholder="Enter your email"
                                       autocomplete="email" />
                    </ChildContent>
                    <Helper>
                        <RadzenRequiredValidator Component="Email" Text="Email is required" />
                        <RadzenEmailValidator Component="Email" Text="Provide a valid email address" />
                    </Helper>
                </RadzenFormField>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-6" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenButton ButtonType="ButtonType.Submit" 
                              Text="Send Reset Link" 
                              IsBusy="@isBusy"
                              BusyText="Sending..."
                              Variant="Variant.Flat" 
                              ButtonStyle="ButtonStyle.Primary" 
                              Style="width: 100%;" />
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-4" JustifyContent="JustifyContent.Center">
                <RadzenLink Path="/login" Text="Back to login" />
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenColumn>
</RadzenRow>

@code {
    private ResetPasswordModel model = new();
    private bool errorVisible;
    private string error = string.Empty;
    private bool isBusy;

    private async Task OnSubmit(ResetPasswordModel model)
    {
        try
        {
            isBusy = true;
            errorVisible = false;

            var response = await Http.PostAsJsonAsync("Account/ResetPassword", new
            {
                userName = model.Email
            });

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Password reset instructions have been sent to your email.",
                    Duration = 8000
                });

                NavigationManager.NavigateTo("/login?info=Password reset instructions sent. Check your email.");
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                errorVisible = true;
                error = errorMessage;
            }
        }
        catch (Exception ex)
        {
            errorVisible = true;
            error = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

    public class ResetPasswordModel
    {
        public string Email { get; set; } = string.Empty;
    }
}